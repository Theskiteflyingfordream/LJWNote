用户表

乘客表

订单表



列车信息（列车号，起始站id，终点站id，时间）

站点信息（站id，站点名）

经停站信息（列车号，到达顺序，到达时间，停留时间，出发时间，价格）

座位表（日期，列车号，用数字表示的区间，binary串表示的座位状态（从当前站到下一站，1表示有人坐，0表示没人坐））



操作表（列车id，日期，状态(停运or正常)）



如何找余票？

首先从数据库中，

然后根据传入的起始站和终点站，找到分别在经停站信息的下标，然后从起始站到终点站，将每一列的byte相或，放到result[]中，比如这一行的byte[0]或下一行的byte[0]，最后为了提高计算result[]数组中的1的个数，对每8个byte，使用Long.bitCount计算，剩下不足8个的，每4个用bitCount计算，最后不足4个的，每个byte计算，所有计算结果的和就是余票。



如果占坐？

首先开一个事务

同样按照上面的方法得到result[]数组后，遍历每一位，依次将下标取余%5，分类ABCDE类座位放入集合中，然后然后遍历用户要求类别，对于每个座位开一个事务处理。在处理中用update更新它，然后根据返回的受影响行数判断是否成功，如果受影响行数与预期的不符合的话，说明这个过程中有人修改了它，那么手动抛出异常，回滚，进行下一个座位的判断。

如何取消订单？

取消订单不需要开启事务，只要构造一个byte，置对应的位为1，其它为0，然后一个update语句异或就行了。



用到的索引：

座位表中用列车号座位主键，然后列车号和日期和区间做一个索引。



难点是座位表的设计

因为座位表不仅要考虑到每一个位，也要考虑到每一个站，



缺点：

并没有用自增id作为主键，而是用列车号作为主键；

并没有使用缓存。